<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <title>Data Visualization</title>
    <link rel="stylesheet" href="style.css">
    <style>
        .tooltip {
            position: absolute;
            background-color: white;
            border: 1px solid black;
            padding: 5px;
            display: none;
        }
    </style>
</head>
<body>
    <div class="title-box">
        <p class="title-text"> 
            US Slave Appraisals
            <a href="https://github.com/tonyyyycui/slave-appraisal-datavis">
                <svg class="github-logo" viewBox="0 0 16 16" version="1.1" width="18" height="18" aria-hidden="true">
                    <path fill-rule="evenodd" d="M8 0C3.58 0 0 3.58 0 8c0 3.54 2.29 6.53 5.47 7.59.4.07.55-.17.55-.38 0-.19-.01-.82-.01-1.49-2.01.37-2.53-.49-2.69-.94-.09-.23-.48-.94-.82-1.13-.28-.15-.68-.52-.01-.53.63-.01 1.08.58 1.23.82.72 1.21 1.87.87 2.33.66.07-.52.28-.87.51-1.07-1.78-.2-3.64-.89-3.64-3.95 0-.87.31-1.59.82-2.15-.08-.2-.36-1.02.08-2.12 0 0 .67-.21 2.2.82.64-.18 1.32-.27 2-.27.68 0 1.36.09 2 .27 1.53-1.04 2.2-.82 2.2-.82.44 1.1.16 1.92.08 2.12.51.56.82 1.27.82 2.15 0 3.07-1.87 3.75-3.65 3.95.29.25.54.73.54 1.48 0 1.07-.01 1.93-.01 2.2 0 .21.15.46.55.38A8.013 8.013 0 0016 8c0-4.42-3.58-8-8-8z"></path>
                </svg>
            </a>
        </p>
        <div class="title-right">
            <p style="text-align: right; margin: 0">Tony Cui</p>
        </div>
    </div>


    <!-- Create a container for the graph -->
    <div id="container"></div>

    <!-- Create toggle switch
    <label class="switch">
        <input id="toggle" type="checkbox">
        <span class="slider"></span>
    </label>
    <span id="toggle-label">Use CPI in 2014</span> -->

    <!-- Add buttons for filtering by age -->
    <button onclick="filterByAge(0, 10)">Filter by Age 0-10</button>
    <button onclick="filterByAge(11, 22)">Filter by Age 11-22</button>
    <button onclick="filterByAge(23, 39)">Filter by Age 23-39</button>
    <button onclick="filterByAge(40, 100)">Filter by Age 40+</button>

     <!-- Add buttons for filtering by state -->
     <div id="state-buttons">
        <button onclick="filterByState('NC')">NC</button>
        <button onclick="filterByState('GA')">GA</button>
        <button onclick="filterByState('TX')">TX</button>
        <button onclick="filterByState('TN')">TN</button>
        <button onclick="filterByState('LA')">LA</button>
        <button onclick="filterByState('AL')">AL</button>
        <button onclick="filterByState('VA')">VA</button>
        <button onclick="filterByState('MS')">MS</button>
        <button onclick="filterByState('unspecified')">Unspecified</button>

    </div>

      <!-- Add buttons for filtering by gender -->
      <div id="gender-buttons">
        <button onclick="filterByGender('male')">Male</button>
        <button onclick="filterByGender('female')">Female</button>
    </div>

      <!-- Input fields for filtering data by year -->
      <div id="year-filter">
        <label for="start-year">Start Year:</label>
        <input type="number" id="start-year" placeholder="YYYY" />

        <label for="end-year">End Year:</label>
        <input type="number" id="end-year" placeholder="YYYY" />

        <button onclick="filterByYear()">Filter by Years</button>
    </div>

    

    <div class="title-box">
        <p style="text-align: center; font-weight: bold;">
            Berry Slave Value Database
        </p>
    </div>

    <div class="tooltip" id="tooltip"></div>

    <!-- Load D3.js -->
    <script src="https://cdn.jsdelivr.net/npm/d3@7"></script>
    
    <!-- Load custom JavaScript -->
    <script>

function filterByState(state) {
            let filteredData;
            
            if (state === 'unspecified') {
                // Filter data where state is missing or unspecified
                filteredData = data.filter(d => !d.state || d.state.trim() === '');
            } else {
                // Filter data based on the selected state
                filteredData = data.filter(d => d.state === state);
            }
            
            updateData(filteredData);
        }

         // Function to filter data by year range
function filterByYear() {
    // Get the start and end years from input fields
    const startYear = parseInt(document.getElementById('start-year').value, 10);
    const endYear = parseInt(document.getElementById('end-year').value, 10);

    // Check if the input years are valid integers and start year is less than or equal to end year
    if (isNaN(startYear) || isNaN(endYear) || startYear > endYear) {
        alert("Please provide a valid year range where start year is less than or equal to end year.");
        return;
    }

    // Convert start and end years to Date objects
    const startDate = new Date(startYear, 0, 1); // January 1st of start year
    const endDate = new Date(endYear, 11, 31); // December 31st of end year

    // Filter data within the specified year range
    const filteredData = data.filter(d => {
        // Convert `d.year` to a Date object, if not already
        const dataDate = new Date(d.year);
        // Compare `dataDate` with `startDate` and `endDate`
        return dataDate >= startDate && dataDate <= endDate;
    });

    // Update the graph with the filtered data
    updateData(filteredData);
}
        // Function to filter data by age
        function filterByAge(minAge, maxAge) {
            const filteredData = data.filter(d => {
                const age = parseFloat(d.age);
                return age >= minAge && age <= maxAge;
            });
            updateData(filteredData);
        }

         // Function to filter data by gender
         function filterByGender(gender) {
            const filteredData = data.filter(d => d.sex === gender);
            updateData(filteredData);
        }

        // Declare the chart dimensions and margins.
        const width = 800;
        const height = 600; // Increased size
        const marginTop = 50; // Adjusted margins
        const marginRight = 50;
        const marginBottom = 100;
        const marginLeft = 100;

        // Create the SVG container.
        const svg = d3.select("#container").append("svg")
            .attr("width", width)
            .attr("height", height);

        // Function to update data and redraw the graph
        function updateData(filteredData) {
            // Remove existing SVG elements
            svg.selectAll("*").remove();

            // Calculate the new width and height of the chart area
            const chartWidth = width - marginLeft - marginRight;
            const chartHeight = height - marginTop - marginBottom;

            // Create x scale
            const x = d3.scaleTime()
                .domain(d3.extent(filteredData, d => d.year))
                .range([0, chartWidth]);

            // Create y scale
            const y = d3.scaleLinear()
                .domain([0, d3.max(filteredData, d => d.appraisal)])
                .range([chartHeight, 0]);

            // Append SVG container for the chart area
            const chart = svg.append("g")
                .attr("transform", `translate(${marginLeft},${marginTop})`);

            // Add x-axis
            chart.append("g")
                .attr("class", "x-axis")
                .attr("transform", `translate(0,${chartHeight})`)
                .call(d3.axisBottom(x).ticks(5));

            // Add x-axis label
            chart.append("text")
                .attr("class", "x-axis-label")
                .attr("text-anchor", "middle")
                .attr("x", chartWidth / 2)
                .attr("y", chartHeight + 40) // Adjusted position
                .text("Year");

            // Add y-axis
            chart.append("g")
                .attr("class", "y-axis")
                .call(d3.axisLeft(y));

            // Add y-axis label
            chart.append("text")
                .attr("class", "y-axis-label")
                .attr("text-anchor", "middle")
                .attr("transform", "rotate(-90)")
                .attr("x", -chartHeight / 2)
                .attr("y", -60) // Adjusted position
                .text("CPI");

            // Plot the data points
            chart.selectAll("circle")
                .data(filteredData)
                .enter().append("circle")
                .attr("cx", d => x(d.year)) // Correctly assign x-values based on the date scale
                .attr("cy", d => y(d.appraisal))
                .attr("r", 5)
                .on("mouseover", function(event, d) {
                    showTooltip(d);
                })
                .on("mouseout", function() {
                    hideTooltip();
                });
        }

        function showTooltip(data) {
    const tooltip = document.getElementById('tooltip');
    tooltip.innerHTML = `Name: ${data.name}<br>Age: ${data.age}<br>Sex: ${data.sex}<br>State: ${data.state}`;
    tooltip.style.display = 'block';
    tooltip.style.left = (d3.event.pageX + 10) + 'px';
    tooltip.style.bottom = 'auto'; // Reset bottom property
    tooltip.style.top = ''; // Reset top property
}

function hideTooltip() {
    const tooltip = document.getElementById('tooltip');
    tooltip.style.display = 'none';
}

        // Read the CSV data.
        let data;

        // Fetch data
        d3.csv("berry-data.csv").then(csvData => {
            data = csvData;
            data.forEach(d => {
                d.year = new Date(+d.year, 0, 1); // Parse year as date
                d.appraisal = +d['app.cpi.2014']; // Parse appraisal value
                d.name = d['name']; // Parse name field
                 d.age = +d['age']; // Parse age field
                 d.sex = d['sex']; // Parse sex field
                d.state = d['state']; // Parse state field


            });
            updateData(data); // Initial draw with default data

            // Add event listener to toggle switch
            document.getElementById('toggle').addEventListener('change', function() {
                updateData(data);
            });
        }).catch(error => {
            console.log("Error loading data:", error);
        });
    </script>
</body>
</html>
