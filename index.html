<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="utf-8">
    <title>Data Visualization</title>
    <link rel="stylesheet" href="style.css">
    <style>
        /* Styling for tooltips */
        .tooltip {
            position: absolute;
            background-color: white;
            border: 1px solid black;
            padding: 5px;
            display: none;
        }

        /* Styling for title boxes */
        .title-box {
            width: 100%;
            box-sizing: border-box;
            padding: 10px;
            background-color: #f0f0f0;
            margin: 0;
            display: flex;
            justify-content: space-between;
        }

        /* Styling for the larger filter box */
        .filter-container {
            background-color: #f2e4f2;
            padding: 10px;
            margin-bottom: 10px;
        }

        /* Styling for each filter box */
        .filter-box,
        .progress-box {
            border: 1px solid black;
            padding: 10px;
            margin-bottom: 10px;
            background-color: #f2e4f2; /* Same background color as filter boxes */
        }

        /* Styling for filter titles */
        .filter-title {
            background-color: #f2a2c0;
            padding: 5px;
            margin: 0;
            font-weight: bold;
            border-bottom: 1px solid black;
            text-align: center; /* This will center the text */
        }

        /* Container for the entire main content area */
        .main-content {
            display: flex;
        }

        /* Styling for the graph container */
        .graph-container {
            flex: 3; /* Takes up three times the space of the summary box */
            margin-right: 20px;
        }

        /* Styling for the right-hand summary box */
        .summary-box {
            flex: 1; /* Takes up one-third the width of the main content */
            padding: 10px;
            border: 1px solid black;
        }

        /* Styles for the progress bar */
        #progress-bar {
            width: 300px; /* Adjust width as needed */
            height: 20px;
            background-color: #e0e0e0; /* Light gray background */
            border-radius: 10px; /* Rounded corners */
            position: relative; /* Necessary for positioning */
        }

        #progress {
            height: 100%; /* Full height */
            background-color: #4caf50; /* Green color for progress */
            border-radius: 10px 0 0 10px; /* Rounded corners on the left */
            transition: width 0.5s; /* Smooth width transition */
        }

        /* Styles for the labels */
        #label {
            font-size: 14px;
            margin-bottom: 5px;
        }

        #percentage-label {
            font-size: 14px;
            margin-top: 5px;
        }
    </style>
</head>

<body>
    <div class="title-box">
        <p class="title-text">
            US Slave Appraisals Across Time
            <a href="https://github.com/tonyyyycui/slave-appraisal-datavis">
                <svg class="github-logo" viewBox="0 0 16 16" version="1.1" width="18" height="18" aria-hidden="true">
                    <path fill-rule="evenodd" d="M8 0C3.58 0 0 3.58 0 8c0 3.54 2.29 6.53 5.47 7.59.4.07.55-.17.55-.38 0-.19-.01-.82-.01-1.49-2.01.37-2.53-.49-2.69-.94-.09-.23-.48-.94-.82-1.13-.28-.15-.68-.52-.01-.53.63-.01 1.08.58 1.23.82.72 1.21 1.87.87 2.33.66.07-.52.28-.87.51-1.07-1.78-.2-3.64-.89-3.64-3.95 0-.87.31-1.59.82-2.15-.08-.2-.36-1.02.08-2.12 0 0 .67-.21 2.2.82.64-.18 1.32-.27 2-.27.68 0 1.36.09 2 .27 1.53-1.04 2.2-.82 2.2-.82.44 1.1.16 1.92.08 2.12.51.56.82 1.27.82 2.15 0 3.07-1.87 3.75-3.65 3.95.29.25.54.73.54 1.48 0 1.07-.01 1.93-.01 2.2 0 .21.15.46.55.38A8.013 8.013 0 0016 8c0-4.42-3.58-8-8-8z"></path>
                </svg>
            </a>
        </p>
        <div class="title-right">
            <p style="text-align: right; margin: 0">Tony Cui</p>
            <a href="https://www.figma.com/file/qCSGyweDkN6D027P1ctq4H/Slavery-Appraisal?type=design&node-id=0%3A1&mode=design&t=bNIwOMbnrs2t4QDK-1" style="text-align: right; margin: 0">Explore the mockup here!</a>
        </div>
    </div>

    <!-- Main content area with filters, graph, and summary box -->
    <div class="main-content">
        <!-- Left sidebar for filters -->
        <div style="width: 20%;">
            <!-- Filter by Age -->
            <div class="filter-box">
                <p class="filter-title" style="font-weight: bold;">Filter by Age</p>
                <button onclick="filterByAge(0, 10)">Age 0-10</button>
                <button onclick="filterByAge(11, 22)">Age 11-22</button>
                <button onclick="filterByAge(23, 39)">Age 23-39</button>
                <button onclick="filterByAge(40, 100)">Age 40+</button>
            </div>

            <!-- Filter by State -->
            <div class="filter-box">
                <p class="filter-title" style="font-weight: bold;">Filter by State</p>
                <button onclick="filterByState('NC')">NC</button>
                <button onclick="filterByState('GA')">GA</button>
                <button onclick="filterByState('TX')">TX</button>
                <button onclick="filterByState('TN')">TN</button>
                <button onclick="filterByState('LA')">LA</button>
                <button onclick="filterByState('AL')">AL</button>
                <button onclick="filterByState('VA')">VA</button>
                <button onclick="filterByState('MS')">MS</button>
                <button onclick="filterByState('unspecified')">Unspecified</button>
            </div>

            <!-- Filter by Gender -->
            <div class="filter-box">
                <p class="filter-title" style="font-weight: bold;">Filter by Gender</p>
                <button onclick="filterByGender('male')">Male</button>
                <button onclick="filterByGender('female')">Female</button>
            </div>

            <!-- Filter by Year -->
            <div class="filter-box">
                <p class="filter-title" style="font-weight: bold;">Filter by Year</p>
                <label for="start-year">Start Year:</label>
                <input type="number" id="start-year" placeholder="YYYY" />

                <label for="end-year">End Year:</label>
                <input type="number" id="end-year" placeholder="YYYY" />

                <button onclick="filterByYear()">Filter by Years</button>
            </div>
        </div>

        <!-- Graph container -->
        <div class="graph-container">
            <div id="container"></div> <!-- Graph container -->
        </div>

        <!-- Right-hand section with summary and progress bar -->
        <div class="summary-box">
            <div class="progress-box"> <!-- New box for progress bar -->
                <p class="filter-title">Number of Observations</p> <!-- Title for progress bar section -->
                <div id="label">Filtered: 0 / 8437</div>
                <div id="progress-bar">
                    <div id="progress"></div>
                </div>
                <div id="percentage-label">0% filtered</div>
            </div>

            <p id="range-value">Range: </p>
            <p id="iqr-value">IQR: </p>
            <p id="median-value">Median: </p>
            <p id="mean-value">Mean: </p>
            <p id="observations-value">Number of Observations: </p>
            <!-- <div id="boxplot-container"></div> New container for the boxplot -->
        </div>
    </div>
        
    </div>

    <div class="title-box">
        <p style="text-align: center; width: 100%; font-weight: bold;">
            Berry Slave Value Database
        </p>
    </div>

    <div class="tooltip" id="tooltip"></div>

    <!-- Load D3.js -->
    <script src="https://cdn.jsdelivr.net/npm/d3@7"></script>

    <!-- Load custom JavaScript -->
    <script>
// function createBoxplot(filteredData) {
//     // Calculate the summary statistics for the filtered data
//     const stats = calculateSummaryStatistics(filteredData);

//     // Calculate the quartiles
//     const q1 = stats.iqr / 2;
//     const q3 = stats.iqr * 1.5;
//     const median = stats.median;

//     // Find min and max values for the whiskers (within 1.5 IQR from the quartiles)
//     const minWhisker = d3.min(filteredData, d => d.appraisal >= q1 ? d.appraisal : null);
//     const maxWhisker = d3.max(filteredData, d => d.appraisal <= q3 ? d.appraisal : null);

//     // Create an SVG container for the boxplot
//     const svg = d3.select('.summary-box')
//         .append('svg')
//         .attr('width', 200)
//         .attr('height', 100);

//     // Set up the scale
//     const xScale = d3.scaleLinear()
//         .domain([d3.min(filteredData, d => d.appraisal), d3.max(filteredData, d => d.appraisal)])
//         .range([0, 180]);

//     // Create and add the box (from Q1 to Q3)
//     svg.append('rect')
//         .attr('x', xScale(q1))
//         .attr('y', 40)
//         .attr('width', xScale(q3) - xScale(q1))
//         .attr('height', 20)
//         .attr('fill', '#c0c0c0');

//     // Add the median line
//     svg.append('line')
//         .attr('x1', xScale(median))
//         .attr('x2', xScale(median))
//         .attr('y1', 35)
//         .attr('y2', 65)
//         .attr('stroke', 'black')
//         .attr('stroke-width', 2);

//     // Add the whiskers
//     svg.append('line')
//         .attr('x1', xScale(minWhisker))
//         .attr('x2', xScale(q1))
//         .attr('y1', 50)
//         .attr('y2', 50)
//         .attr('stroke', 'black')
//         .attr('stroke-width', 2);

//     svg.append('line')
//         .attr('x1', xScale(maxWhisker))
//         .attr('x2', xScale(q3))
//         .attr('y1', 50)
//         .attr('y2', 50)
//         .attr('stroke', 'black')
//         .attr('stroke-width', 2);

//     // Update the summary statistics
//     updateStatisticsDisplay(stats);
// }

// Function to calculate summary statistics
function progressBar(dataPointsLeft){
       // Total points and filtered points (you can update filteredPoints as needed)
       const totalPoints = 8437;
        let filteredPoints = dataPointsLeft; // Example: 2,500 observations filtered

        // Calculate the percentage of observations filtered
        const percentage = (filteredPoints / totalPoints) * 100;

        // Update the progress bar width based on the percentage of filtered points
        const progress = document.getElementById('progress');
        progress.style.width = `${percentage}%`;

        // Update the label with the filtered and total points
        const label = document.getElementById('label');
        label.innerText = `Filtered: ${filteredPoints} / ${totalPoints}`;

        // Update the percentage label with the percentage of observations filtered
        const percentageLabel = document.getElementById('percentage-label');
        percentageLabel.innerText = `${percentage.toFixed(1)}% filtered`;
}



function calculateSummaryStatistics(filteredData) {
    // Calculate range
    const minValue = d3.min(filteredData, d => d.appraisal);
    const maxValue = d3.max(filteredData, d => d.appraisal);
    const range = maxValue - minValue;
    
    // Calculate IQR (interquartile range)
    const q1 = d3.quantile(filteredData.map(d => d.appraisal).sort(d3.ascending), 0.25);
    const q3 = d3.quantile(filteredData.map(d => d.appraisal).sort(d3.ascending), 0.75);
    const iqr = q3 - q1;
    
    // Calculate median
    const median = d3.median(filteredData, d => d.appraisal);
    
    // Calculate mean
    const mean = d3.mean(filteredData, d => d.appraisal);
    
    // Calculate number of observations
    const numberOfObservations = filteredData.length;
    
    return {
        range,
        iqr,
        median,
        mean,
        numberOfObservations
    };
}
function filterByState(state) {
            let filteredData;
            
            if (state === 'unspecified') {
                // Filter data where state is missing or unspecified
                filteredData = data.filter(d => !d.state || d.state.trim() === '');
            } else {
                // Filter data based on the selected state
                filteredData = data.filter(d => d.state === state);
            }
            
            updateData(filteredData);
        }

         // Function to filter data by year range
function filterByYear() {
    // Get the start and end years from input fields
    const startYear = parseInt(document.getElementById('start-year').value, 10);
    const endYear = parseInt(document.getElementById('end-year').value, 10);

    // Check if the input years are valid integers and start year is less than or equal to end year
    if (isNaN(startYear) || isNaN(endYear) || startYear > endYear) {
        alert("Please provide a valid year range.");
        return;
    }

    // Convert start and end years to Date objects
    const startDate = new Date(startYear, 0, 1); // January 1st of start year
    const endDate = new Date(endYear, 11, 31); // December 31st of end year

    // Filter data within the specified year range
    const filteredData = data.filter(d => {
        // Convert `d.year` to a Date object, if not already
        const dataDate = new Date(d.year);
        // Compare `dataDate` with `startDate` and `endDate`
        return dataDate >= startDate && dataDate <= endDate;
    });

    // Update the graph with the filtered data
    updateData(filteredData);
}
        // Function to filter data by age
        function filterByAge(minAge, maxAge) {
            const filteredData = data.filter(d => {
                const age = parseFloat(d.age);
                return age >= minAge && age <= maxAge;
            });
            updateData(filteredData);
        }

         // Function to filter data by gender
         function filterByGender(gender) {
            const filteredData = data.filter(d => d.sex === gender);
            updateData(filteredData);
        }

        // Declare the chart dimensions and margins.
        const width = 800;
        const height = 600; // Increased size
        const marginTop = 50; // Adjusted margins
        const marginRight = 50;
        const marginBottom = 100;
        const marginLeft = 100;

        // Create the SVG container.
        const svg = d3.select("#container").append("svg")
            .attr("width", width)
            .attr("height", height);

function updateData(filteredData) {


    // Remove existing SVG elements
    svg.selectAll("*").remove();

    // createBoxplot(filteredData);

    // Calculate the new width and height of the chart area
    const chartWidth = width - marginLeft - marginRight;
    const chartHeight = height - marginTop - marginBottom;

    // Calculate summary statistics for the filtered data
    const stats = calculateSummaryStatistics(filteredData);
    // Display the calculated statistics
    updateStatisticsDisplay(stats);

    // Create x scale
    const x = d3.scaleTime()
        .domain(d3.extent(filteredData, d => d.year))
        .range([0, chartWidth]);

    // Create y scale
    const y = d3.scaleLinear()
        .domain([0, d3.max(filteredData, d => d.appraisal)])
        .range([chartHeight, 0]);

    // Append SVG container for the chart area
    const chart = svg.append("g")
        .attr("transform", `translate(${marginLeft},${marginTop})`);

    // Add x-axis with transition
    const xAxis = d3.axisBottom(x).ticks(5);
    chart.append("g")
        .attr("class", "x-axis")
        .attr("transform", `translate(0,${chartHeight})`)
        .transition()
        .duration(750) // 750ms transition duration
        .call(xAxis);

    // Add y-axis with transition
    const yAxis = d3.axisLeft(y);
    chart.append("g")
        .attr("class", "y-axis")
        .transition()
        .duration(750) // 750ms transition duration
        .call(yAxis);

    // Add x-axis label
    chart.append("text")
        .attr("class", "x-axis-label")
        .attr("text-anchor", "middle")
        .attr("x", chartWidth / 2)
        .attr("y", chartHeight + 40)
        .text("Year");

    // Add y-axis label
    chart.append("text")
        .attr("class", "y-axis-label")
        .attr("text-anchor", "middle")
        .attr("transform", "rotate(-90)")
        .attr("x", -chartHeight / 2)
        .attr("y", -60)
        .text("CPI");

    // Bind the filtered data
    const circles = chart.selectAll("circle")
        .data(filteredData);

    // Transition existing circles to their new positions
    circles.transition()
        .duration(750) // 750ms transition duration
        .attr("cx", d => x(d.year))
        .attr("cy", d => y(d.appraisal))
        .attr("r", 5);

    // Add new circles with transitions
    circles.enter()
        .append("circle")
        .attr("cx", d => x(d.year))
        .attr("cy", d => y(d.appraisal))
        .attr("r", 5)
        .on("mouseover", function(event, d) {
            showTooltip(d);
        })
        .on("mouseout", function() {
            hideTooltip();
        })
        .transition()
        .duration(750) // 750ms transition duration
        .attr("opacity", 1);

    // Remove old circles with transition
    circles.exit()
        .transition()
        .duration(750) // 750ms transition duration
        .attr("opacity", 0)
        .remove();

    progressBar(filteredData.length);
    console.log(filteredData.length)
}

// Function to update the statistics display
function updateStatisticsDisplay(stats) {
    // Assuming you have HTML elements to display the statistics
    document.getElementById('range-value').innerText = `Range: ${stats.range}`;
    document.getElementById('iqr-value').innerText = `IQR: ${stats.iqr}`;
    document.getElementById('median-value').innerText = `Median: ${stats.median}`;
    document.getElementById('mean-value').innerText = `Mean: ${stats.mean}`;
    document.getElementById('observations-value').innerText = `Number of Observations: ${stats.numberOfObservations}`;
}


        function showTooltip(data) {
    const tooltip = document.getElementById('tooltip');
    tooltip.innerHTML = `Name: ${data.name}<br>Age: ${data.age}<br>Sex: ${data.sex}<br>State: ${data.state}`;
    tooltip.style.display = 'block';
    tooltip.style.left = (d3.event.pageX + 10) + 'px';
    tooltip.style.bottom = 'auto'; // Reset bottom property
    tooltip.style.top = ''; // Reset top property
}

function hideTooltip() {
    const tooltip = document.getElementById('tooltip');
    tooltip.style.display = 'none';
}

        // Read the CSV data.
        let data;

        // Fetch data
        d3.csv("berry-data.csv").then(csvData => {
            data = csvData;
            data.forEach(d => {
                d.year = new Date(+d.year, 0, 1); // Parse year as date
                d.appraisal = +d['app.cpi.2014']; // Parse appraisal value
                d.name = d['name']; // Parse name field
                 d.age = +d['age']; // Parse age field
                 d.sex = d['sex']; // Parse sex field
                d.state = d['state']; // Parse state field


            });
            updateData(data); // Initial draw with default data

            // Add event listener to toggle switch
            document.getElementById('toggle').addEventListener('change', function() {
                updateData(data);
            });
        }).catch(error => {
            console.log("Error loading data:", error);
        });
    </script>
</body>
</html>
